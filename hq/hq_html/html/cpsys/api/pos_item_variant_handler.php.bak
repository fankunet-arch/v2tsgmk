<?php
/**
 * TopTea HQ - POS Item Variants Management API
 * File: /hq/hq_html/html/cpsys/api/pos_item_variant_handler.php
 * Purpose: CRUD for pos_item_variants + ensure selected recipe (kds_products) is linked
 *          via pos_menu_items.product_code (menu-item level).
 */
require_once realpath(__DIR__ . '/../../../core/config.php');
require_once APP_PATH . '/helpers/auth_helper.php';

header('Content-Type: application/json; charset=utf-8');
function send_json_response($status, $message, $data = null) {
    echo json_encode(['status' => $status, 'message' => $message, 'data' => $data], JSON_UNESCAPED_UNICODE);
    exit;
}

@session_start();
// 仅限超级管理员（与其它 cpsys API 保持一致）
if (($_SESSION['role_id'] ?? null) !== ROLE_SUPER_ADMIN) {
    http_response_code(403);
    send_json_response('error', '权限不足 (Permission denied)');
}

$action = '';
$json_data = [];
if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['action'])) {
    $action = $_GET['action'];
} elseif ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $raw = file_get_contents('php://input');
    $json_data = json_decode($raw, true) ?: [];
    $action = $json_data['action'] ?? '';
}

try {
    switch ($action) {

        case 'get': {
            $id = filter_input(INPUT_GET, 'id', FILTER_VALIDATE_INT);
            if (!$id) { send_json_response('error', '无效的ID。'); }

            $sql = "SELECT 
                        pv.id,
                        pv.menu_item_id,
                        pv.variant_name_zh,
                        pv.variant_name_es,
                        pv.price_eur,
                        pv.sort_order,
                        pv.is_default,
                        mi.product_code,
                        p.id AS product_id
                    FROM pos_item_variants pv
                    INNER JOIN pos_menu_items mi ON pv.menu_item_id = mi.id
                    LEFT JOIN kds_products p ON mi.product_code = p.product_code AND p.deleted_at IS NULL
                    WHERE pv.id = ? AND pv.deleted_at IS NULL";
            $stmt = $pdo->prepare($sql);
            $stmt->execute([$id]);
            $row = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$row) {
                http_response_code(404);
                send_json_response('error', '记录不存在。');
            }
            send_json_response('success', 'ok', $row);
        }

        case 'save': {
            $d = $json_data['data'] ?? [];
            $id = !empty($d['id']) ? (int)$d['id'] : null;

            // 基本校验
            $menu_item_id   = (int)($d['menu_item_id']   ?? 0);
            $variant_name_zh= trim($d['variant_name_zh'] ?? '');
            $variant_name_es= trim($d['variant_name_es'] ?? '');
            $price_eur      = (float)($d['price_eur']     ?? 0);
            $sort_order     = (int)($d['sort_order']     ?? 99);
            $is_default     = !empty($d['is_default']) ? 1 : 0;
            $product_id     = isset($d['product_id']) && $d['product_id'] !== '' ? (int)$d['product_id'] : null;

            if (!$menu_item_id || $variant_name_zh === '' || $variant_name_es === '' || $price_eur <= 0) {
                http_response_code(400);
                send_json_response('error', '缺少必填项或价格无效。');
            }

            $pdo->beginTransaction();

            // 若选择了配方（kds_products），把菜单项的 product_code 同步到该产品的 product_code（菜单项维度）
            if ($product_id) {
                $stmt = $pdo->prepare("SELECT product_code FROM kds_products WHERE id = ? AND deleted_at IS NULL");
                $stmt->execute([$product_id]);
                $pc = $stmt->fetchColumn();
                if ($pc) {
                    $stmt2 = $pdo->prepare("UPDATE pos_menu_items SET product_code = ? WHERE id = ? AND deleted_at IS NULL");
                    $stmt2->execute([$pc, $menu_item_id]);
                }
            }

            if ($id) {
                $sql = "UPDATE pos_item_variants
                        SET variant_name_zh = :variant_name_zh,
                            variant_name_es = :variant_name_es,
                            price_eur      = :price_eur,
                            sort_order     = :sort_order,
                            is_default     = :is_default
                        WHERE id = :id AND deleted_at IS NULL";
                $stmt = $pdo->prepare($sql);
                $stmt->execute([
                    ':variant_name_zh' => $variant_name_zh,
                    ':variant_name_es' => $variant_name_es,
                    ':price_eur'       => $price_eur,
                    ':sort_order'      => $sort_order,
                    ':is_default'      => $is_default,
                    ':id'              => $id
                ]);
            } else {
                $sql = "INSERT INTO pos_item_variants
                            (menu_item_id, variant_name_zh, variant_name_es, price_eur, is_default, sort_order)
                        VALUES
                            (:menu_item_id, :variant_name_zh, :variant_name_es, :price_eur, :is_default, :sort_order)";
                $stmt = $pdo->prepare($sql);
                $stmt->execute([
                    ':menu_item_id'    => $menu_item_id,
                    ':variant_name_zh' => $variant_name_zh,
                    ':variant_name_es' => $variant_name_es,
                    ':price_eur'       => $price_eur,
                    ':is_default'      => $is_default,
                    ':sort_order'      => $sort_order
                ]);
                $id = (int)$pdo->lastInsertId();
            }

            // 保证同一 menu_item 仅一个默认规格
            if ($is_default === 1) {
                $stmt = $pdo->prepare("UPDATE pos_item_variants SET is_default = 0 WHERE menu_item_id = ? AND id <> ?");
                $stmt->execute([$menu_item_id, $id]);
            }

            $pdo->commit();
            send_json_response('success', '规格已保存。');
        }

        case 'delete': {
            $id = (int)($json_data['id'] ?? 0);
            if (!$id) { send_json_response('error', '无效的ID。'); }
            $stmt = $pdo->prepare("UPDATE pos_item_variants SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?");
            $stmt->execute([$id]);
            send_json_response('success', '规格已删除。');
        }

        default:
            http_response_code(400);
            send_json_response('error', '无效的操作请求。');
    }
} catch (PDOException $e) {
    if ($pdo->inTransaction()) { $pdo->rollBack(); }
    http_response_code(500);
    send_json_response('error', '数据库操作失败。', ['debug' => $e->getMessage()]);
}
?>
